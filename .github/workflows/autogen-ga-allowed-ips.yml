name: "Auto commit and push changes about allowed github actions runner ips"

# Tested and disable schedule
on: workflow_dispatch
# on:
#   schedule:
#     - cron: '23 3 * * SUN'
#   workflow_dispatch:


env:
  GITHUB_ACTIONS_RUNNER_ALLOW_IPS_FILE: ./path/to/allowed_ip/rules.txt

jobs:
  update-ga-runner-allowed-ips:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

      - name: Update Ips
        id: generate
        run: |
          mkdir -p $(dirname $GITHUB_ACTIONS_RUNNER_ALLOW_IPS_FILE)
          cat << EOF > $GITHUB_ACTIONS_RUNNER_ALLOW_IPS_FILE
          #
          # WARNING: THIS FILE AUTOGEN BY GITHUB ACTIONS, SEE: .github/workflows/cron-update-ga-runner-ips.yml
          #
          # github actions ips
          # https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners#ip-addresses
          #
          EOF
          curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/meta | jq -r '.actions' | grep -v : | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}\b" | xargs -L1 printf 'allow %s;\n' >> $GITHUB_ACTIONS_RUNNER_ALLOW_IPS_FILE
          git diff | head -10
          echo "::set-output name=updated::no"
          git diff --no-ext-diff --quiet --exit-code || echo "::set-output name=updated::yes"

#       - name: Commit changes
#         uses: EndBug/add-and-commit@v9
#         with:
#           message: "cd(actions): autogen ga runner allowed ips (${{ steps.date.outputs.date }})"
#           default_author: github_actions

      - name: Create Pull Request
        id: cpr
        if: ${{ steps.generate.outputs.updated == 'yes' }}
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'Generated by protoapic'
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: cd-autogen-ga-runner-allowed-ips
          delete-branch: true
          title: 'GA(autogen): Ëá™Âä®Êõ¥Êñ∞ GitHub Actions Runner ÁôΩÂêçÂçï'
          body: |
            ü§ñ RT ü§ñ
          labels: |
            robot
          reviewers: ${{ github.actor }}
          draft: false
